generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
}

enum CompanyStatus {
  PROSPECTO
  POTENCIAL
  CLIENTE
  DESCARTADA
  INACTIVA
}

enum CompanyOrigin {
  PROSPECCION_MANUAL
  REFERIDO_CLIENTE
  REFERIDO_ALIADO
  INBOUND_MARKETING
  OUTBOUND_MARKETING
  EVENTO_PRESENCIAL
}

enum DealViewPreference {
  TABLE
  KANBAN
}

enum ThemePreference {
  LIGHT
  DARK
  SYSTEM
}

enum QuoteStatus {
  BORRADOR
  ACTIVA
  RECHAZADA
  APROBADA
}

enum Currency {
  USD
  DOP
}

enum TaxType {
  INCLUIDOS
  NO_INCLUIDOS
}

enum PaymentFrequency {
  PAGO_UNICO
  MENSUAL
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

enum ActivityType {
  EMAIL
  NOTE
  CALL
  MEETING
  PROJECT
  CLIENT_USER
}

enum ProjectStatus {
  ACTIVE
  INACTIVE
}

enum EmailStatus {
  SENT
  FAILED
  PENDING
}

enum UserType {
  INTERNAL  // Equipo NEARBY (@nearbycrm.com)
  CLIENT    // Contacto de empresa cliente
}

model User {
  id            String             @id @default(cuid())
  name          String?
  email         String             @unique
  passwordHash  String
  photoUrl      String?
  userType        UserType           @default(INTERNAL)
  dealsViewPref   DealViewPreference @default(TABLE)
  themePreference ThemePreference    @default(LIGHT)
  itemsPerPage    Int                @default(10)
  
  // Table Preferences (sorting, filters, visible columns per table)
  tablePreferences Json?
  
  // Email Configuration (Personal - for sending emails)
  emailConfigured  Boolean @default(false)
  emailFromAddress String?
  emailFromName    String?
  emailPassword    String? // Gmail app password
  
  // Client user link to Contact
  contactId     String?            @unique
  contact       Contact?           @relation("UserContact", fields: [contactId], references: [id])
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  ownedWorkspaces Workspace[]        @relation("WorkspaceOwner")
  memberships     WorkspaceMember[]
  sentInvitations Invitation[]
  contacts        Contact[]
  companies       Company[]
  deals           Deal[]
  activities      Activity[]
  quotes          Quote[]
}

model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug             String?  @unique
  legalName        String?  // Nombre o Razón social
  rnc              String?  // RNC
  address          String?  @db.Text
  phone            String?
  logoUrl          String?  // Logo path
  contractTemplate String?  @db.Text // Plantilla del contrato en HTML
  contractVersion  String?  // Versión del contrato (ej: "v1.0")
  
  // AdmCloud Integration Settings (Basic Auth)
  admCloudEnabled  Boolean  @default(false)
  admCloudAppId    String?  // App ID de AdmCloud
  admCloudUsername String?  // Usuario para Basic Auth
  admCloudPassword String?  // Contraseña para Basic Auth
  admCloudCompany  String?  // ID de la compañía en AdmCloud
  admCloudRole     String?  // Rol (ej: "Administradores")
  admCloudDefaultPriceListId   String?  // Lista de precios predeterminada
  admCloudDefaultPriceListName String?  // Nombre de lista de precios predeterminada
  
  // ClickUp Integration Settings
  clickUpEnabled       Boolean  @default(false)
  clickUpApiToken      String?  // Personal API Token
  clickUpWorkspaceId   String?  // Team/Workspace ID
  clickUpListId        String?  // ID de la lista de tickets
  clickUpClientFieldId String?  // ID del campo personalizado "Cliente"
  
  // Automatic Billing Configuration
  billingEnabled       Boolean  @default(false)  // Enable automatic billing
  billingEmailsCC      String?  // CC emails (comma separated)
  billingEmailsBCC     String?  // BCC emails (comma separated)
  billingEmailSubject  String?  // Email subject template
  billingEmailBody     String?  @db.Text  // Email body template
  billingFromUserId    String?  // User ID to use for sending emails
  
  createdAt        DateTime @default(now())
  ownerId     String
  owner       User     @relation("WorkspaceOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  subscription Subscription?
  members      WorkspaceMember[]
  invitations  Invitation[]
  contacts     Contact[]
  companies    Company[]
  deals        Deal[]
  activities   Activity[]
  billingHistory BillingHistory[]
}

model WorkspaceMember {
  id          String     @id @default(cuid())
  workspaceId String
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role        MemberRole @default(MEMBER)
  joinedAt    DateTime   @default(now())

  @@unique([workspaceId, userId])
}

model Invitation {
  id          String           @id @default(cuid())
  workspaceId String
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  email       String
  role        MemberRole       @default(MEMBER)
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  invitedBy   String
  inviter     User             @relation(fields: [invitedBy], references: [id])
  createdAt   DateTime         @default(now())
  expiresAt   DateTime
}

model Subscription {
  id          String             @id @default(cuid())
  workspaceId String             @unique
  workspace   Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  plan        Plan               @default(FREE)
  status      SubscriptionStatus @default(ACTIVE)
  startedAt   DateTime           @default(now())
  cancelledAt DateTime?
}

model Company {
  id               String         @id @default(cuid())
  name             String
  logoUrl          String?
  taxId            String?        // RNC
  legalName        String?        // Razón Social
  fiscalAddress    String?        @db.Text  // Dirección Fiscal
  initialProjects  Int?           @default(0)  // Proyectos iniciales contratados
  initialUsers     Int?           @default(0)  // Usuarios iniciales contratados
  quoteId          String?        // Id. Cotización (ej: "COT-001")
  quoteFileUrl     String?        // URL del PDF de la cotización (Vercel Blob)
  country          String?
  city             String?
  phone            String?
  website          String?
  instagramUrl     String?
  linkedinUrl      String?
  primaryContactId String?
  primaryContact   Contact?       @relation("PrimaryContact", fields: [primaryContactId], references: [id])
  origin           CompanyOrigin?
  status           CompanyStatus  @default(PROSPECTO)
  
  // Terms & Conditions
  termsAccepted       Boolean   @default(false)
  termsAcceptedAt     DateTime?
  termsAcceptedById   String?
  termsAcceptedByName String?   // Nombre de quien firmó
  termsVersion        String?   // Ej: "v1.0 - 2026-01"
  
  // AdmCloud Integration
  admCloudRelationshipId String?  // ID del cliente en AdmCloud (RelationshipID)
  admCloudLastSync       DateTime? // Última sincronización con AdmCloud
  
  // ClickUp Integration
  clickUpClientName      String?  // Nombre del cliente en ClickUp (campo personalizado)
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contacts             Contact[]          @relation("CompanyContacts")
  deals                Deal[]
  activities           Activity[]
  quotes               Quote[]
  clientInvitations    ClientInvitation[]
  projects             Project[]
  clientUsers          ClientUser[]
  subscriptionBilling  SubscriptionBilling?
  billingHistory       BillingHistory[]
}

enum ContactStatus {
  PROSPECTO
  POTENCIAL
  CLIENTE
  INVERSIONISTA
  DESCARTADO
}

enum DealType {
  CLIENTE_NUEVO
  UPSELLING
}

enum DealStatus {
  PROSPECCION
  CALIFICACION
  NEGOCIACION
  FORMALIZACION
  CIERRE_GANADO
  CIERRE_PERDIDO
  NO_CALIFICADOS
}

model Contact {
  id           String        @id @default(cuid())
  fullName     String
  photoUrl     String?
  title        String?
  email        String
  mobile       String?
  instagramUrl String?
  linkedinUrl  String?
  status       ContactStatus @default(PROSPECTO)
  
  // Billing preferences
  receivesInvoices Boolean @default(false) // Receives invoices/proformas automatically

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation("CompanyContacts", fields: [companyId], references: [id])

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  primaryCompanies  Company[]          @relation("PrimaryContact")
  deals             Deal[]
  activities        Activity[]
  quotes            Quote[]
  clientInvitations ClientInvitation[]
  userAccount       User?              @relation("UserContact")
}

model ClientInvitation {
  id          String           @id @default(cuid())
  companyId   String
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId   String
  contact     Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  expiresAt   DateTime
  usedAt      DateTime?
  
  @@index([token])
  @@index([companyId])
  @@index([contactId])
}

model Deal {
  id     String     @id @default(cuid())
  name   String
  value  Decimal    @default(0)
  mrr    Decimal?
  arr    Decimal?
  type   DealType?
  status DealStatus @default(PROSPECCION)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities Activity[]
  quotes     Quote[]
}

model Quote {
  id                 String            @id @default(cuid())
  number             Int               // Auto-increment per deal
  date               DateTime          @default(now())
  validity           String            // "10 días", "20 días", "30 días"
  status             QuoteStatus       @default(BORRADOR)
  
  // Totals
  totalOneTime       Decimal           @default(0)
  totalMonthly       Decimal           @default(0)
  
  // Additional fields
  proposalDescription String?          @db.Text
  paymentConditions   String?          @db.Text
  currency            Currency          @default(USD)
  deliveryTime        String?
  taxType             TaxType           @default(INCLUIDOS)
  
  // Relations
  dealId      String
  deal        Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  
  companyId   String?
  company     Company? @relation(fields: [companyId], references: [id])
  
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  items QuoteItem[]
  
  @@unique([dealId, number])
}

model QuoteItem {
  id        String           @id @default(cuid())
  name      String
  price     Decimal
  quantity  Decimal
  frequency PaymentFrequency @default(PAGO_UNICO)
  netPrice  Decimal          // price * quantity
  
  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Activity {
  id   String       @id @default(cuid())
  type ActivityType

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // Relations to entities
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)

  dealId String?
  deal   Deal?   @relation(fields: [dealId], references: [id], onDelete: Cascade)

  // Email specific fields
  emailTo      String?
  emailSubject String?
  emailBody    String?  @db.Text
  emailStatus  EmailStatus?
  attachments  String?  @db.Text // JSON array of file paths
  errorMsg     String?  @db.Text

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([workspaceId])
  @@index([companyId])
  @@index([contactId])
  @@index([dealId])
}

model Project {
  id        String        @id @default(cuid())
  name      String
  status    ProjectStatus @default(ACTIVE)
  
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([companyId])
}

model ClientUser {
  id        String        @id @default(cuid())
  fullName  String
  email     String
  status    ProjectStatus @default(ACTIVE)
  
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([companyId])
}

enum BillingType {
  STANDARD      // Cobro estándar basado en items
  CUSTOM        // Cobro personalizado (futuro)
}

enum CountType {
  MANUAL            // Cantidad manual
  ACTIVE_PROJECTS   // Totaliza proyectos activos
  ACTIVE_USERS      // Totaliza usuarios activos
  CALCULATED        // Fórmula: (usuarios o proyectos) - valor base
}

enum CalculatedBase {
  PROJECTS          // Usa proyectos activos como base
  USERS             // Usa usuarios activos como base
}

model SubscriptionBilling {
  id                 String      @id @default(cuid())
  companyId          String      @unique
  company            Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  billingType        BillingType @default(STANDARD)
  autoBillingEnabled Boolean     @default(false) // Habilitar cobro automático
  billingDay         Int         @default(1) // Día del mes para generar factura (1-31)
  
  items        SubscriptionItem[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SubscriptionItem {
  id                    String       @id @default(cuid())
  subscriptionBillingId String
  subscriptionBilling   SubscriptionBilling @relation(fields: [subscriptionBillingId], references: [id], onDelete: Cascade)
  
  // ADMCloud item reference
  admCloudItemId        String       // ID del artículo en ADMCloud
  code                  String       // Código del artículo
  description           String       // Descripción del artículo
  price                 Decimal      // Precio del artículo
  
  // Quantity configuration
  countType             CountType    @default(MANUAL)
  manualQuantity        Int?         // Cantidad manual (si countType es MANUAL)
  
  // Calculated type configuration (cuando countType es CALCULATED)
  calculatedBase        CalculatedBase?  // Base: proyectos o usuarios
  calculatedSubtract    Int?             // Valor entero a restar
  
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  
  @@index([subscriptionBillingId])
}

// Billing History - Records of sent invoices/proformas
enum BillingHistoryStatus {
  PENDING      // Pending to send
  SENT         // Successfully sent
  FAILED       // Send failed
  CANCELLED    // Manually cancelled
}

model BillingHistory {
  id              String               @id @default(cuid())
  
  companyId       String
  company         Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  workspaceId     String
  workspace       Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  
  // ADMCloud document reference
  admCloudDocId   String?              // Document ID in ADMCloud
  proformaNumber  String?              // Proforma number (e.g., "PRO-00123")
  
  // Timing
  generatedAt     DateTime             @default(now())
  sentAt          DateTime?
  
  // Recipients
  recipients      String               @db.Text  // JSON array of recipient emails
  ccRecipients    String?              @db.Text  // JSON array of CC emails
  
  // Document
  pdfUrl          String?              // URL of generated PDF (Vercel Blob)
  
  // Status
  status          BillingHistoryStatus @default(PENDING)
  errorMessage    String?              @db.Text
  
  // Billing period
  billingMonth    Int                  // Month of billing (1-12)
  billingYear     Int                  // Year of billing
  
  // Amounts
  subtotal        Decimal              @default(0)
  taxAmount       Decimal              @default(0)
  totalAmount     Decimal              @default(0)
  currency        Currency             @default(USD)
  
  // Items snapshot (JSON for historical record)
  itemsSnapshot   String?              @db.Text  // JSON array of items at time of billing
  
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  
  @@index([companyId])
  @@index([workspaceId])
  @@index([billingMonth, billingYear])
}
